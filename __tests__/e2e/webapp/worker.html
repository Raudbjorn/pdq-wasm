<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDQ Worker Test - Multi-Worker Performance</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-card h2 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }

    .stat-value.processing {
      color: #2196F3;
    }

    .stat-value.success {
      color: #4CAF50;
    }

    .stat-value.error {
      color: #f44336;
    }

    .worker-pool {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .worker-pool h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
    }

    .workers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }

    .worker-card {
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      font-size: 12px;
    }

    .worker-card.idle {
      border-color: #9E9E9E;
    }

    .worker-card.busy {
      border-color: #2196F3;
      background: #E3F2FD;
    }

    .worker-card.error {
      border-color: #f44336;
      background: #FFEBEE;
    }

    .worker-header {
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .worker-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .worker-status.idle {
      background: #9E9E9E;
      color: white;
    }

    .worker-status.busy {
      background: #2196F3;
      color: white;
    }

    .worker-status.error {
      background: #f44336;
      color: white;
    }

    .worker-info {
      color: #666;
      font-size: 11px;
      margin-top: 5px;
    }

    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .controls h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
    }

    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
      transition: background 0.2s;
    }

    button:hover {
      background: #1976D2;
    }

    button:disabled {
      background: #BDBDBD;
      cursor: not-allowed;
    }

    .results {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .results h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
    }

    .hash-list {
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .hash-item {
      padding: 8px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .hash-item:last-child {
      border-bottom: none;
    }

    .hash-filename {
      font-weight: 600;
      color: #333;
    }

    .hash-value {
      color: #666;
      font-size: 11px;
    }

    .hash-worker {
      color: #2196F3;
      font-size: 10px;
      margin-left: 10px;
    }

    .test-info {
      background: #e3f2fd;
      border: 1px solid #2196F3;
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
      font-size: 13px;
      color: #1976D2;
    }

    .test-info code {
      background: #bbdefb;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2196F3, #4CAF50);
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PDQ Worker Pool Test</h1>
      <p class="subtitle">Testing 12-worker parallel image hashing with Web Workers</p>
    </header>

    <div class="stats-grid">
      <div class="stat-card">
        <h2>Total Files</h2>
        <div class="stat-value" id="total-files">0</div>
      </div>
      <div class="stat-card">
        <h2>Processed</h2>
        <div class="stat-value success" id="processed-files">0</div>
      </div>
      <div class="stat-card">
        <h2>Processing</h2>
        <div class="stat-value processing" id="processing-files">0</div>
      </div>
      <div class="stat-card">
        <h2>Failed</h2>
        <div class="stat-value error" id="failed-files">0</div>
      </div>
      <div class="stat-card">
        <h2>Avg Time</h2>
        <div class="stat-value" id="avg-time">0ms</div>
      </div>
      <div class="stat-card">
        <h2>Total Time</h2>
        <div class="stat-value" id="total-time">0ms</div>
      </div>
    </div>

    <div class="worker-pool">
      <h2>Worker Pool Status (12 Workers)</h2>
      <div class="workers-grid" id="workers-grid"></div>
    </div>

    <div class="controls">
      <h2>Test Controls</h2>
      <button id="start-test" onclick="startTest()">Start Test</button>
      <button id="reset-test" onclick="resetTest()">Reset</button>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>

    <div class="results">
      <h2>Hash Results</h2>
      <div class="hash-list" id="hash-list"></div>
    </div>

    <div class="test-info">
      <strong>E2E Test Info:</strong> This page uses 12 Web Workers to process images in parallel using <code>PDQ.initWorker()</code> and <code>generateHashFromBlob()</code>.
      Each worker operates independently, hashing images concurrently for maximum performance.
    </div>
  </div>

  <script type="module">
    const WORKER_COUNT = 12;
    const workers = [];
    const workerStats = new Map();
    let testFiles = [];
    let processedCount = 0;
    let failedCount = 0;
    let processingCount = 0;
    let startTime = 0;
    let hashTimes = [];

    // Initialize worker pool
    async function initWorkers() {
      const workersGrid = document.getElementById('workers-grid');
      workersGrid.innerHTML = '';

      for (let i = 0; i < WORKER_COUNT; i++) {
        const worker = new Worker('./pdq-worker.js');

        workerStats.set(i, {
          id: i,
          status: 'initializing',
          currentFile: null,
          processed: 0,
          errors: 0
        });

        // Create worker UI card
        const card = document.createElement('div');
        card.className = 'worker-card idle';
        card.id = `worker-${i}`;
        card.innerHTML = `
          <div class="worker-header">
            <span>Worker ${i + 1}</span>
            <span class="worker-status idle" id="worker-status-${i}">Init</span>
          </div>
          <div class="worker-info" id="worker-info-${i}">Starting...</div>
        `;
        workersGrid.appendChild(card);

        // Handle worker messages
        worker.onmessage = (event) => {
          handleWorkerMessage(i, event.data);
        };

        worker.onerror = (error) => {
          console.error(`Worker ${i} error:`, error);
          console.error(`Worker ${i} error details:`, {
            message: error.message,
            filename: error.filename,
            lineno: error.lineno,
            colno: error.colno,
            error: error.error
          });
          updateWorkerUI(i, 'error', `Error: ${error.message || 'Unknown'}`);
        };

        // Initialize worker
        worker.postMessage({ type: 'init' });

        workers.push(worker);
      }

      console.log(`Initialized ${WORKER_COUNT} workers`);
    }

    function handleWorkerMessage(workerId, data) {
      const { type, hash, filename, error, duration } = data;

      switch (type) {
        case 'ready':
          workerStats.get(workerId).status = 'idle';
          updateWorkerUI(workerId, 'idle', 'Ready');
          checkAllWorkersReady();
          break;

        case 'hash-result':
          processedCount++;
          processingCount--;
          workerStats.get(workerId).processed++;
          workerStats.get(workerId).status = 'idle';
          workerStats.get(workerId).currentFile = null;

          hashTimes.push(duration);

          addHashResult(filename, hash, workerId, duration);
          updateWorkerUI(workerId, 'idle', `Done: ${filename}`);
          updateStats();

          // Process next file if available
          processNextFile(workerId);
          break;

        case 'error':
          failedCount++;
          processingCount--;
          workerStats.get(workerId).errors++;
          workerStats.get(workerId).status = 'error';
          workerStats.get(workerId).currentFile = null;

          updateWorkerUI(workerId, 'error', `Error: ${error}`);
          updateStats();

          // Process next file despite error
          setTimeout(() => processNextFile(workerId), 1000);
          break;
      }
    }

    function checkAllWorkersReady() {
      const allReady = Array.from(workerStats.values()).every(stat => stat.status === 'idle');
      if (allReady) {
        document.getElementById('start-test').disabled = false;
        console.log('All workers ready!');
      }
    }

    function updateWorkerUI(workerId, status, info) {
      const card = document.getElementById(`worker-${workerId}`);
      const statusEl = document.getElementById(`worker-status-${workerId}`);
      const infoEl = document.getElementById(`worker-info-${workerId}`);

      card.className = `worker-card ${status}`;
      statusEl.className = `worker-status ${status}`;
      statusEl.textContent = status === 'idle' ? 'IDLE' : status === 'busy' ? 'BUSY' : 'ERROR';
      infoEl.textContent = info;
    }

    function addHashResult(filename, hash, workerId, duration) {
      const hashList = document.getElementById('hash-list');
      const item = document.createElement('div');
      item.className = 'hash-item';
      item.innerHTML = `
        <div>
          <span class="hash-filename">${filename}</span>
          <span class="hash-worker">W${workerId + 1}</span>
          <span class="hash-worker">${duration}ms</span>
        </div>
        <span class="hash-value">${hash}</span>
      `;
      hashList.appendChild(item);
    }

    function updateStats() {
      document.getElementById('processed-files').textContent = processedCount;
      document.getElementById('processing-files').textContent = processingCount;
      document.getElementById('failed-files').textContent = failedCount;

      if (hashTimes.length > 0) {
        const avgTime = Math.round(hashTimes.reduce((a, b) => a + b, 0) / hashTimes.length);
        document.getElementById('avg-time').textContent = `${avgTime}ms`;
      }

      const totalTime = startTime > 0 ? Date.now() - startTime : 0;
      document.getElementById('total-time').textContent = `${totalTime}ms`;

      // Update progress bar
      const progress = testFiles.length > 0 ? (processedCount + failedCount) / testFiles.length * 100 : 0;
      document.getElementById('progress-fill').style.width = `${progress}%`;
    }

    function processNextFile(workerId) {
      if (testFiles.length === 0) {
        // Check if all done
        if (processingCount === 0) {
          console.log('All files processed!');
          const totalTime = Date.now() - startTime;
          console.log(`Total time: ${totalTime}ms`);
          console.log(`Processed: ${processedCount}, Failed: ${failedCount}`);
        }
        return;
      }

      const file = testFiles.shift();
      processingCount++;

      workerStats.get(workerId).status = 'busy';
      workerStats.get(workerId).currentFile = file.name;

      updateWorkerUI(workerId, 'busy', `Hashing: ${file.name}`);
      updateStats();

      workers[workerId].postMessage({
        type: 'hash',
        data: { file: file.blob, filename: file.name }
      });
    }

    window.startTest = async function() {
      // Load test files
      const fileNames = [
        'red-circle.png',
        'blue-square.png',
        'green-triangle.png',
        'red-circle-copy.png'
      ];

      document.getElementById('start-test').disabled = true;
      testFiles = [];
      processedCount = 0;
      failedCount = 0;
      processingCount = 0;
      hashTimes = [];
      startTime = Date.now();
      document.getElementById('hash-list').innerHTML = '';

      // Generate test set - replicate files to create workload
      const replicaCount = Math.ceil(WORKER_COUNT * 3 / fileNames.length); // 3x workers

      for (let i = 0; i < replicaCount; i++) {
        for (const fileName of fileNames) {
          try {
            const response = await fetch(`../fixtures/${fileName}`);
            const blob = await response.blob();
            testFiles.push({
              name: `${fileName.replace('.png', '')}-${i + 1}.png`,
              blob
            });
          } catch (error) {
            console.error(`Failed to load ${fileName}:`, error);
          }
        }
      }

      document.getElementById('total-files').textContent = testFiles.length;
      console.log(`Loaded ${testFiles.length} files for processing`);

      // Start processing - distribute to all workers
      for (let i = 0; i < Math.min(WORKER_COUNT, testFiles.length); i++) {
        processNextFile(i);
      }
    };

    window.resetTest = function() {
      testFiles = [];
      processedCount = 0;
      failedCount = 0;
      processingCount = 0;
      hashTimes = [];
      startTime = 0;
      document.getElementById('hash-list').innerHTML = '';
      document.getElementById('total-files').textContent = '0';
      updateStats();
      document.getElementById('progress-fill').style.width = '0%';
      document.getElementById('start-test').disabled = false; // Re-enable start button
    };

    // Expose for E2E tests
    window.workers = workers;
    window.workerStats = workerStats;
    window.getResults = () => ({
      totalFiles: testFiles.length + processedCount + failedCount,
      processed: processedCount,
      failed: failedCount,
      processing: processingCount,
      avgTime: hashTimes.length > 0 ? Math.round(hashTimes.reduce((a, b) => a + b, 0) / hashTimes.length) : 0,
      totalTime: startTime > 0 ? Date.now() - startTime : 0
    });

    // Initialize workers on page load
    initWorkers();
    console.log('Worker pool initialized');
  </script>
</body>
</html>
